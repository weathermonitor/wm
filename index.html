<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Monitor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            min-height: 100vh;
        }
        
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .login-box {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .login-box h1 {
            margin-bottom: 30px;
            font-size: 2rem;
        }
        
        .login-box input {
            width: 200px;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 20px;
        }
        
        .login-box button {
            padding: 12px 30px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .login-box button:hover {
            background: #45a049;
        }
        
        .main-container {
            display: none;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .radius-info {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-top: 10px;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .location-buttons, .time-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid transparent;
        }
        
        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .btn.active {
            background: #4CAF50;
            border-color: #45a049;
        }
        
        .current-status {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .status-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
        }
        
        .status-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .thunderstorm-high { color: #ff4444; }
        .thunderstorm-medium { color: #ffaa00; }
        .thunderstorm-low { color: #4CAF50; }
        
        .hourly-forecast {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .hourly-forecast h3 {
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.5rem;
        }
        
        .hour-item {
            background: rgba(0, 0, 0, 0.3);
            margin-bottom: 10px;
            border-radius: 10px;
            transition: all 0.3s;
        }
        
        .hour-item:hover {
            background: rgba(0, 0, 0, 0.4);
        }
        
        .hour-summary {
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .hour-time {
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .hour-conditions {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .condition-item {
            text-align: center;
        }
        
        .condition-label {
            font-size: 0.8rem;
            opacity: 0.8;
            display: block;
        }
        
        .condition-value {
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
        }
        
        .error {
            background: rgba(255, 0, 0, 0.2);
            border: 1px solid #ff4444;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
        }
        
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .hour-summary {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .hour-conditions {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="login-container" id="loginContainer">
        <div class="login-box">
            <h1>üå©Ô∏è Weather Monitor</h1>
            <input type="password" id="passwordInput" placeholder="Enter password" />
            <br>
            <button onclick="checkPassword()">Access Monitor</button>
        </div>
    </div>

    <div class="main-container" id="mainContainer">
        <div class="header">
            <h1>üå©Ô∏è Weather Monitor</h1>
            <p id="currentLocation">New Wales, FL</p>
            <div class="radius-info">Monitoring 5-mile radius for lightning activity</div>
        </div>

        <div class="controls">
            <div class="location-buttons">
                <button class="btn active" data-location="0" onclick="selectLocation(0)">New Wales</button>
                <button class="btn" data-location="1" onclick="selectLocation(1)">Bartow</button>
                <button class="btn" data-location="2" onclick="selectLocation(2)">South Pierce</button>
            </div>
            <div class="time-buttons">
                <button class="btn active" data-time="today" onclick="selectTime('today')">Today</button>
                <button class="btn" data-time="tomorrow" onclick="selectTime('tomorrow')">Tomorrow</button>
            </div>
        </div>

        <div class="current-status">
            <h2>Current Conditions</h2>
            <div class="status-grid">
                <div class="status-item">
                    <div class="status-value" id="currentThunderstorm">--</div>
                    <div>Lightning Risk</div>
                </div>
                <div class="status-item">
                    <div class="status-value" id="currentRain">--</div>
                    <div>Rain Intensity</div>
                </div>
                <div class="status-item">
                    <div class="status-value" id="currentCondition">--</div>
                    <div>Weather Condition</div>
                </div>
            </div>
        </div>

        <div class="hourly-forecast">
            <h3>Hourly Forecast</h3>
            <div id="hourlyData" class="loading">Loading weather data...</div>
        </div>
    </div>

    <script>
        // Encrypted configuration (Base64 encoded for obfuscation)
        const config = {
            password: 'S0FH',
            apiKey: 'ekF1Yk1ob1hUZ00weWhTeTR4S2dJeTJkRkxST3p5MnE=',
            locations: [
                { name: 'New Wales', lat: 'MjcuODcxMQ==', lon: 'LTgxLjk5NjE=' },
                { name: 'Bartow', lat: 'MjcuODk2NA==', lon: 'LTgxLjg0MzI=' },
                { name: 'South Pierce', lat: 'MjcuNzY0OA==', lon: 'LTgxLjkzODU=' }
            ]
        };

        // Application state
        let currentLocation = 0;
        let currentTime = 'today';
        let dataCache = {};
        let lastRefreshByCombo = {};
        let hourlyCallCount = 0;
        let lastHourReset = Date.now();

        // Rate limiting settings
        const RATE_LIMITS = {
            minInterval: 350,                    // 350ms between API calls
            maxHourly: 24,                      // Maximum 24 calls per hour
            cacheTime: 30 * 60 * 1000,         // 30-minute cache duration
            minRefreshInterval: 30 * 60 * 1000  // 30-minute refresh interval per combo
        };

        // Utility functions
        function decode(encoded) {
            return atob(encoded);
        }

        function getCacheKey(location, time) {
            return `${location}_${time}`;
        }

        function getCachedData(location, time) {
            const key = getCacheKey(location, time);
            const cached = dataCache[key];
            
            if (cached && (Date.now() - cached.timestamp < RATE_LIMITS.cacheTime)) {
                return cached.data;
            }
            
            return null;
        }

        function setCachedData(location, time, data) {
            const key = getCacheKey(location, time);
            dataCache[key] = {
                data: data,
                timestamp: Date.now()
            };
        }

        function checkRateLimit() {
            const now = Date.now();
            
            // Reset hourly counter
            if (now - lastHourReset > 60 * 60 * 1000) {
                hourlyCallCount = 0;
                lastHourReset = now;
            }
            
            if (hourlyCallCount >= RATE_LIMITS.maxHourly) {
                throw new Error('Hourly rate limit exceeded');
            }
        }

        function updateApiCallCount() {
            hourlyCallCount++;
        }

        function formatTime(dateInput) {
            try {
                const date = new Date(dateInput);
                if (isNaN(date.getTime())) return '--:--';
                
                return date.toLocaleTimeString([], { 
                    hour: 'numeric', 
                    minute: '2-digit',
                    hour12: true 
                });
            } catch {
                return '--:--';
            }
        }

        function formatRainIntensity(intensity) {
            if (intensity === 0) return 'None';
            if (intensity < 0.1) return 'Light';
            if (intensity < 0.3) return 'Moderate';
            return 'Heavy';
        }

        function getWeatherCondition(code) {
            const conditions = {
                1000: 'Clear', 1001: 'Cloudy', 1100: 'Mostly Clear',
                1101: 'Partly Cloudy', 1102: 'Mostly Cloudy', 2000: 'Fog',
                2100: 'Light Fog', 4000: 'Drizzle', 4001: 'Rain',
                4200: 'Light Rain', 4201: 'Heavy Rain', 8000: 'Thunderstorm'
            };
            return conditions[code] || 'Unknown';
        }

        // Authentication
        function checkPassword() {
            const input = document.getElementById('passwordInput').value;
            if (btoa(input) === config.password) {
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('mainContainer').style.display = 'block';
                loadWeatherData();
            } else {
                alert('Incorrect password');
            }
        }

        // Location and time selection
        function selectLocation(index) {
            currentLocation = index;
            document.querySelectorAll('[data-location]').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-location="${index}"]`).classList.add('active');
            document.getElementById('currentLocation').textContent = 
                `${config.locations[index].name}, FL`;
            loadWeatherData();
        }

        function selectTime(time) {
            currentTime = time;
            document.querySelectorAll('[data-time]').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-time="${time}"]`).classList.add('active');
            loadWeatherData();
        }

        // Weather data functions
        function updateCurrentConditions(data) {
            const thunderstormElement = document.getElementById('currentThunderstorm');
            const rainElement = document.getElementById('currentRain');
            const conditionElement = document.getElementById('currentCondition');

            // Thunderstorm probability with color coding
            const thunderstormProb = data.thunderstormProbability || 0;
            thunderstormElement.textContent = `${thunderstormProb}%`;
            
            if (thunderstormProb >= 60) {
                thunderstormElement.className = 'status-value thunderstorm-high';
            } else if (thunderstormProb >= 30) {
                thunderstormElement.className = 'status-value thunderstorm-medium';
            } else {
                thunderstormElement.className = 'status-value thunderstorm-low';
            }

            // Rain intensity
            const rainIntensity = data.precipitationIntensity || 0;
            rainElement.textContent = formatRainIntensity(rainIntensity);

            // Weather condition
            const weatherCode = data.weatherCode || 1000;
            conditionElement.textContent = getWeatherCondition(weatherCode);
        }

        function updateHourlyForecast(intervals) {
            const container = document.getElementById('hourlyData');
            
            if (!intervals || intervals.length === 0) {
                container.innerHTML = '<div class="error">No forecast data available</div>';
                return;
            }

            const hoursHtml = intervals.map((interval) => {
                const timeDisplay = formatTime(interval.startTime);
                const values = interval.values || {};
                const thunderstormProb = values.thunderstormProbability || 0;
                const rainProb = values.precipitationProbability || 0;
                const rainIntensity = values.precipitationIntensity || 0;
                
                let thunderstormClass = 'thunderstorm-low';
                if (thunderstormProb >= 60) thunderstormClass = 'thunderstorm-high';
                else if (thunderstormProb >= 30) thunderstormClass = 'thunderstorm-medium';

                return `
                    <div class="hour-item">
                        <div class="hour-summary">
                            <div class="hour-time">${timeDisplay}</div>
                            <div class="hour-conditions">
                                <div class="condition-item">
                                    <span class="condition-label">Lightning</span>
                                    <span class="condition-value ${thunderstormClass}">${thunderstormProb}%</span>
                                </div>
                                <div class="condition-item">
                                    <span class="condition-label">Rain</span>
                                    <span class="condition-value">${rainProb}%</span>
                                </div>
                                <div class="condition-item">
                                    <span class="condition-label">Rain Intensity</span>
                                    <span class="condition-value">${formatRainIntensity(rainIntensity)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = hoursHtml;
        }

        // Main weather loading function
        async function loadWeatherData() {
            // Check cache first
            const cachedData = getCachedData(currentLocation, currentTime);
            if (cachedData) {
                updateCurrentConditions(cachedData.current);
                updateHourlyForecast(cachedData.hourly.intervals);
                
                const cacheAge = Math.round((Date.now() - cachedData.timestamp) / 60000);
                document.getElementById('hourlyData').innerHTML = 
                    document.getElementById('hourlyData').innerHTML + 
                    `<div style="text-align: center; margin-top: 10px; font-size: 0.9rem; opacity: 0.7;">
                        üì± Using cached data (${cacheAge} min old)
                    </div>`;
                return;
            }

            // Check if this combo was recently refreshed
            const comboKey = getCacheKey(currentLocation, currentTime);
            const lastRefresh = lastRefreshByCombo[comboKey] || 0;
            const now = Date.now();
            
            if (now - lastRefresh < RATE_LIMITS.minRefreshInterval) {
                const waitTime = Math.ceil((RATE_LIMITS.minRefreshInterval - (now - lastRefresh)) / 60000);
                document.getElementById('hourlyData').innerHTML = 
                    `<div class="error">‚è±Ô∏è This location was refreshed ${30 - waitTime} minutes ago. Please wait ${waitTime} more minutes for fresh data.</div>`;
                return;
            }

            // Get location data
            const location = config.locations[currentLocation];
            const lat = parseFloat(decode(location.lat));
            const lon = parseFloat(decode(location.lon));
            const apiKey = decode(config.apiKey);

            // Calculate time range
            const nowDate = new Date();
            let startTime, endTime;
            
            if (currentTime === 'today') {
                startTime = nowDate.toISOString();
                const endOfDay = new Date(nowDate);
                endOfDay.setHours(23, 59, 59, 999);
                endTime = endOfDay.toISOString();
            } else {
                const tomorrow = new Date(nowDate);
                tomorrow.setDate(tomorrow.getDate() + 1);
                tomorrow.setHours(0, 0, 0, 0);
                startTime = tomorrow.toISOString();
                
                tomorrow.setHours(23, 59, 59, 999);
                endTime = tomorrow.toISOString();
            }

            try {
                checkRateLimit();
                
                document.getElementById('hourlyData').innerHTML = 
                    '<div class="loading">üå§Ô∏è Loading fresh weather data...</div>';
                
                // Current conditions
                const currentResponse = await fetch(
                    `https://api.tomorrow.io/v4/weather/realtime?location=${lat},${lon}&fields=precipitationIntensity,thunderstormProbability,weatherCode&apikey=${apiKey}`
                );
                updateApiCallCount();
                
                if (!currentResponse.ok) {
                    throw new Error(`Current weather API error: ${currentResponse.status}`);
                }
                
                const currentData = await currentResponse.json();
                updateCurrentConditions(currentData.data.values);

                // Wait between calls
                await new Promise(resolve => setTimeout(resolve, RATE_LIMITS.minInterval));
                checkRateLimit();

                // Hourly forecast
                const forecastResponse = await fetch(
                    `https://api.tomorrow.io/v4/timelines?location=${lat},${lon}&fields=precipitationIntensity,precipitationProbability,thunderstormProbability,weatherCode&timesteps=1h&startTime=${encodeURIComponent(startTime)}&endTime=${encodeURIComponent(endTime)}&apikey=${apiKey}`
                );
                updateApiCallCount();
                
                if (!forecastResponse.ok) {
                    throw new Error(`Forecast API error: ${forecastResponse.status}`);
                }
                
                const forecastData = await forecastResponse.json();
                const hourlyData = forecastData.data.timelines[0];
                
                // Cache the data
                setCachedData(currentLocation, currentTime, {
                    current: currentData.data.values,
                    hourly: hourlyData,
                    timestamp: Date.now()
                });
                
                updateHourlyForecast(hourlyData.intervals);
                lastRefreshByCombo[comboKey] = Date.now();

            } catch (error) {
                console.error('Weather API error:', error);
                
                if (error.message.includes('429')) {
                    document.getElementById('hourlyData').innerHTML = 
                        `<div style="background: rgba(255, 165, 0, 0.2); border: 1px solid #ffaa00; border-radius: 10px; padding: 20px; text-align: center; margin: 20px 0;">
                            <h3 style="margin-bottom: 10px;">üå§Ô∏è Service Temporarily Busy</h3>
                            <p>Weather data requests are currently at capacity. Please wait a few minutes and try again.</p>
                        </div>`;
                } else if (error.message.includes('Failed to fetch')) {
                    document.getElementById('hourlyData').innerHTML = 
                        `<div style="background: rgba(70, 130, 180, 0.2); border: 1px solid #4682b4; border-radius: 10px; padding: 20px; text-align: center; margin: 20px 0;">
                            <h3 style="margin-bottom: 10px;">üåê Connection Issue</h3>
                            <p>Unable to connect to weather services. Please check your internet connection and try again.</p>
                        </div>`;
                } else {
                    document.getElementById('hourlyData').innerHTML = 
                        `<div style="background: rgba(255, 99, 132, 0.2); border: 1px solid #ff6384; border-radius: 10px; padding: 20px; text-align: center; margin: 20px 0;">
                            <h3 style="margin-bottom: 10px;">‚ö†Ô∏è Service Unavailable</h3>
                            <p>Weather services are temporarily unavailable. Please try again in a few minutes.</p>
                        </div>`;
                }
            }
        }

        // Enter key support for password
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('passwordInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    checkPassword();
                }
            });
        });
    </script>
</body>
</html>